<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة الخدمات الطلابية</title>
    
    <!-- المكتبات -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>

    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Cairo:wght@400;600;700&family=Amiri:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- إعدادات أساسية --- */
        :root { --primary: #3b82f6; --bg-dark: #0f172a; --glass: rgba(30, 41, 59, 0.7); }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-dark); color: white; overflow: hidden; height: 100vh; touch-action: manipulation; }
        
        /* خلفية متحركة */
        .bg-animation { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%); }
        .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.4; animation: float 15s infinite ease-in-out alternate; }
        .orb-1 { width: 60vw; height: 60vw; bg: #3b82f6; top: -20%; left: -20%; background: #1d4ed8; }
        .orb-2 { width: 60vw; height: 60vw; bg: #7c3aed; bottom: -20%; right: -20%; background: #6d28d9; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, -50px) scale(1.1); } }

        /* --- واجهة المستخدم --- */
        .launcher-btn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5);
            border: 2px solid rgba(255,255,255,0.2);
            z-index: 50; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .launcher-btn:active { transform: translateX(-50%) scale(0.9); }
        .launcher-btn i { width: 32px; height: 32px; color: white; transition: 0.3s; }
        .launcher-btn.open { transform: translateX(-50%) rotate(45deg); background: #ef4444; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5); }

        .app-drawer {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(120%);
            width: 90%; max-width: 400px;
            background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 32px;
            padding: 24px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40; visibility: hidden; opacity: 0;
        }
        .app-drawer.active { transform: translateX(-50%) translateY(0); visibility: visible; opacity: 1; }

        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .icon-box {
            width: 60px; height: 60px; border-radius: 18px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .app-icon:hover .icon-box { transform: translateY(-5px); background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .app-label { font-size: 11px; color: rgba(255,255,255,0.8); text-align: center; }

        .tool-view {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 100;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tool-view.active { transform: translateY(0); }
        
        .tool-header {
            padding: 10px 15px; background: rgba(15, 23, 42, 0.98); 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 50;
        }
        .tool-content { flex: 1; overflow: hidden; position: relative; }
        .iframe-full { width: 100%; height: 100%; border: none; background: white; }

        /* --- محرر المستندات (A4 Editor) --- */
        .editor-workspace {
            background-color: #334155; overflow-y: auto; overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; height: 100%;
            position: relative;
        }
        .page-scaler { transform-origin: top center; transition: transform 0.3s ease; padding-bottom: 50px; }
        
        .page-wrapper { position: relative; margin-bottom: 30px; transition: all 0.3s; }
        
        .a4-page {
            width: 210mm; min-height: 297mm; padding: 20mm; 
            background: white; 
            color: #000000 !important; /* فرض اللون الأسود */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            outline: none; position: relative; font-family: 'Cairo', sans-serif;
            overflow: hidden; caret-color: black;
        }
        
        .delete-page-btn {
            position: absolute; top: 0; left: -50px; 
            width: 36px; height: 36px; border-radius: 50%; 
            background: #ef4444; color: white;
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            transition: 0.2s; opacity: 0.6; z-index: 20;
        }
        .delete-page-btn:hover, .page-wrapper:hover .delete-page-btn { opacity: 1; transform: scale(1.1); }
        @media (max-width: 900px) { .delete-page-btn { left: 10px; top: -40px; opacity: 1; } }

        .editor-toolbar {
            display: flex; gap: 6px; overflow-x: auto; padding: 8px; 
            background: #1e293b; border-bottom: 1px solid #334155;
            scrollbar-width: none; align-items: center;
        }
        .editor-btn { 
            padding: 6px; border-radius: 6px; color: #cbd5e1; min-width: 32px; 
            text-align: center; background: rgba(255,255,255,0.05);
        }
        .editor-btn:hover { background: #334155; color: white; }
        .editor-btn.active { background: #3b82f6; color: white; }
        
        .a4-page img { cursor: move; transition: box-shadow 0.2s; display: inline-block; max-width: 100%; }
        .a4-page img:hover { box-shadow: 0 0 0 2px #3b82f6; }
        
        .todo-item { animation: slideIn 0.3s ease forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- الخلفية -->
    <div class="bg-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <!-- الشاشة الرئيسية -->
    <div id="dashboard" class="h-full flex flex-col items-center justify-center text-center p-6 transition-all duration-500">
        <div class="mb-4">
            <h1 class="text-6xl font-bold mb-1 font-brand text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 pb-2 px-2 leading-normal">خدماتي</h1>
            <p class="text-white/60 text-xl font-light">رفيق الطالب الذكي</p>
        </div>
        
        <div id="clock" class="text-7xl font-light font-mono text-white/90 mb-4 tracking-tighter">00:00</div>
        <div id="date" class="text-blue-300 text-sm bg-blue-500/10 px-4 py-1 rounded-full border border-blue-500/20 mb-10">...</div>

        <!-- زر الحقوق (نسخة مصغرة وأنيقة) -->
        <a href="https://instagram.com/c4man" target="_blank" class="group relative flex items-center gap-3 px-5 py-2.5 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all duration-300 hover:scale-105 cursor-pointer backdrop-blur-md shadow-lg">
            <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-pink-600/20 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="w-9 h-9 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md group-hover:rotate-12 transition-transform">
                <i data-lucide="instagram" class="w-5 h-5 text-white"></i>
            </div>
            <div class="text-right">
                <p class="text-[8px] text-white/40 uppercase tracking-widest leading-none mb-0.5">Developed By</p>
                <h3 class="text-lg font-bold text-white tracking-wide font-sans leading-none">C4MAN</h3>
            </div>
        </a>
    </div>

    <!-- الزر العائم للقائمة -->
    <button id="launcher" class="launcher-btn" onclick="toggleDrawer()">
        <i data-lucide="layout-grid"></i>
    </button>

    <!-- القائمة المنبثقة -->
    <div id="app-drawer" class="app-drawer">
        <div class="app-icon" onclick="openTool('tool-editor')"><div class="icon-box bg-amber-500/20 border-amber-500/30"><i data-lucide="file-text" class="w-8 h-8 text-amber-400"></i></div><span class="app-label">المحرر</span></div>
        <div class="app-icon" onclick="openTool('tool-img-pdf')"><div class="icon-box bg-blue-500/20 border-blue-500/30"><i data-lucide="images" class="w-8 h-8 text-blue-400"></i></div><span class="app-label">صور PDF</span></div>
        <div class="app-icon" onclick="openTool('tool-notes')"><div class="icon-box bg-yellow-500/20 border-yellow-500/30"><i data-lucide="sticky-note" class="w-8 h-8 text-yellow-400"></i></div><span class="app-label">الملاحظات</span></div>
        <div class="app-icon" onclick="openTool('tool-todo')"><div class="icon-box bg-purple-500/20 border-purple-500/30"><i data-lucide="check-square" class="w-8 h-8 text-purple-400"></i></div><span class="app-label">المهام</span></div>
        <div class="app-icon" onclick="openTool('tool-quiz')"><div class="icon-box bg-emerald-500/20 border-emerald-500/30"><i data-lucide="brain-circuit" class="w-8 h-8 text-emerald-400"></i></div><span class="app-label">اختبارات</span></div>
        <div class="app-icon" onclick="openTool('tool-calc')"><div class="icon-box bg-cyan-500/20 border-cyan-500/30"><i data-lucide="calculator" class="w-8 h-8 text-cyan-400"></i></div><span class="app-label">حاسبة</span></div>
        <div class="app-icon" onclick="openTool('tool-timer')"><div class="icon-box bg-red-500/20 border-red-500/30"><i data-lucide="timer" class="w-8 h-8 text-red-400"></i></div><span class="app-label">مؤقت</span></div>
        <div class="app-icon" onclick="openTool('tool-qr')"><div class="icon-box bg-gray-500/20 border-gray-500/30"><i data-lucide="qr-code" class="w-8 h-8 text-gray-300"></i></div><span class="app-label">QR</span></div>
        <div class="app-icon" onclick="openTool('tool-chat')"><div class="icon-box bg-indigo-500/20 border-indigo-500/30"><i data-lucide="message-circle" class="w-8 h-8 text-indigo-400"></i></div><span class="app-label">الدعم</span></div>
    </div>

    <!-- ================= أدوات المنصة ================= -->

    <!-- 1. محرر المستندات (مطور) -->
    <div id="tool-editor" class="tool-view">
        <!-- زر العودة السريع عند وضع التركيز (أسفل اليسار) -->
        <button id="focus-fab" onclick="toggleFocusMode()">
            <i data-lucide="minimize" class="w-5 h-5"></i>
        </button>

        <!-- الجزء العلوي (يختفي في وضع التركيز) -->
        <div id="editor-top-section" class="transition-all duration-300">
            <div class="tool-header">
                <div class="flex items-center gap-2">
                    <button onclick="toggleFocusMode()" class="text-slate-400 hover:text-white p-1" title="تكبير الشاشة"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                    <h2 class="text-base font-bold text-white">المحرر</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="addNewPage()" class="bg-slate-700 text-white px-3 py-1.5 rounded-lg text-xs flex items-center gap-1"><i data-lucide="plus" class="w-4 h-4 text-green-400"></i> صفحة</button>
                    <button onclick="generatePDF()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><i data-lucide="download" class="w-4 h-4"></i> PDF</button>
                    <button onclick="closeTool('tool-editor')" class="text-red-300 bg-red-500/20 px-2 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <!-- شريط التنسيق -->
            <div id="editor-toolbar-container">
                <div class="editor-toolbar">
                    <select onchange="formatDoc('fontName', this.value)" class="bg-slate-700 text-white border-0 rounded px-2 py-1 text-xs w-24"><option value="Cairo">القاهرة</option><option value="Tajawal">تجوال</option><option value="Amiri">أميري</option></select>
                    <select onchange="formatDoc('fontSize', this.value)" class="bg-slate-700 text-white border-0 rounded px-2 py-1 text-xs w-14"><option value="3">عادي</option><option value="5">كبير</option><option value="7">عنوان</option></select>
                    <div class="w-px h-5 bg-slate-600 mx-1"></div>
                    <button class="editor-btn font-bold" onclick="formatDoc('bold')">B</button>
                    <button class="editor-btn italic" onclick="formatDoc('italic')">I</button>
                    <button class="editor-btn underline" onclick="formatDoc('underline')">U</button>
                    <div class="w-px h-5 bg-slate-600 mx-1"></div>
                    <!-- مغير الألوان -->
                    <div class="relative flex items-center justify-center w-8 h-8 bg-slate-700 rounded cursor-pointer">
                        <i data-lucide="palette" class="w-4 h-4 text-pink-400"></i>
                        <input type="color" onchange="formatDoc('foreColor', this.value)" class="absolute opacity-0 w-full h-full cursor-pointer" title="لون النص">
                    </div>
                    <div class="w-px h-5 bg-slate-600 mx-1"></div>
                    <button class="editor-btn" onclick="formatDoc('justifyRight')"><i data-lucide="align-right" class="w-4 h-4"></i></button>
                    <button class="editor-btn" onclick="formatDoc('justifyCenter')"><i data-lucide="align-center" class="w-4 h-4"></i></button>
                    <button class="editor-btn" onclick="formatDoc('justifyLeft')"><i data-lucide="align-left" class="w-4 h-4"></i></button>
                    <div class="w-px h-5 bg-slate-600 mx-1"></div>
                    <button class="editor-btn text-yellow-400" onclick="document.getElementById('imgUpload').click()"><i data-lucide="image-plus" class="w-4 h-4"></i></button>
                    <input type="file" id="imgUpload" class="hidden" accept="image/*" onchange="insertImage(this)">
                </div>
            </div>
        </div>

        <!-- مساحة العمل -->
        <div class="editor-workspace" id="editor-scroll" onclick="focusLastPage()">
            <div id="page-scaler" class="page-scaler">
                <!-- الصفحات تضاف هنا -->
            </div>
        </div>
    </div>

    <!-- باقي الأدوات (Iframe) -->
    <div id="tool-img-pdf" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">صور PDF</h2><button onclick="closeTool('tool-img-pdf')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/hello/" class="iframe-full" allow="camera"></iframe></div>
    <div id="tool-notes" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">الملاحظات</h2><button onclick="closeTool('tool-notes')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/ALI/" class="iframe-full"></iframe></div>
    <div id="tool-quiz" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">الاختبارات</h2><button onclick="closeTool('tool-quiz')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/BN/" class="iframe-full"></iframe></div>
    <div id="tool-calc" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">الحاسبة</h2><button onclick="closeTool('tool-calc')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/cl/" class="iframe-full"></iframe></div>
    <div id="tool-timer" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">المؤقت</h2><button onclick="closeTool('tool-timer')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/timer/" class="iframe-full"></iframe></div>
    <div id="tool-qr" class="tool-view"><div class="tool-header"><h2 class="text-white font-bold">ماسح QR</h2><button onclick="closeTool('tool-qr')"><i data-lucide="x" class="text-white"></i></button></div><iframe src="https://engineeralii.github.io/qr0/" class="iframe-full" allow="camera"></iframe></div>

    <!-- المهام (ToDo) -->
    <div id="tool-todo" class="tool-view">
        <div class="tool-header"><h2 class="text-white font-bold">المهام</h2><button onclick="closeTool('tool-todo')"><i data-lucide="x" class="text-white"></i></button></div>
        <div class="p-6 w-full max-w-md mx-auto">
            <div class="flex gap-2 mb-4"><input id="todo-in" class="glass-input flex-1 p-3 rounded-lg text-right" placeholder="مهمة جديدة..."><button onclick="addTodo()" class="bg-purple-600 text-white p-3 rounded-lg"><i data-lucide="plus"></i></button></div>
            <div id="todo-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- الشات -->
    <div id="tool-chat" class="tool-view">
        <div class="tool-header"><h2 class="text-white font-bold">الدعم الفني</h2><button onclick="closeTool('tool-chat')"><i data-lucide="x" class="text-white"></i></button></div>
        <div id="chat-box" class="flex-1 p-4 bg-[#121212] overflow-y-auto space-y-3"><div class="flex gap-3"><div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white/10 p-3 rounded-lg text-sm">مرحباً بك، كيف يمكنني مساعدتك؟</div></div></div>
        <div class="p-4 bg-slate-900 border-t border-white/10 flex gap-2"><input id="chat-input" class="glass-input flex-1 p-3 rounded-lg text-right" placeholder="اكتب..."><button onclick="sendMsg()" class="bg-blue-600 text-white p-3 rounded-lg"><i data-lucide="send"></i></button></div>
    </div>

    <script>
        // --- النظام ---
        function init() {
            lucide.createIcons();
            updateClock(); setInterval(updateClock, 1000);
            loadTodos();
            // تهيئة المحرر
            const container = document.getElementById('page-scaler');
            if(container && container.innerHTML.trim() === '') addNewPage();
            
            window.addEventListener('resize', scaleEditor);
            scaleEditor();
            
            // Add listeners for saving selection
            const pagesCont = document.getElementById('page-scaler');
            if(pagesCont) {
                pagesCont.addEventListener('mouseup', saveSel);
                pagesCont.addEventListener('keyup', saveSel);
                pagesCont.addEventListener('touchend', saveSel);
            }
        }
        
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:false});
            document.getElementById('date').innerText = now.toLocaleDateString('ar-EG', {weekday:'long', day:'numeric', month:'long'});
        }

        function toggleDrawer() {
            document.getElementById('app-drawer').classList.toggle('active');
            document.getElementById('launcher').classList.toggle('open');
        }

        function openTool(id) {
            document.getElementById(id).classList.add('active');
            toggleDrawer();
            if(id === 'tool-editor') setTimeout(scaleEditor, 200);
        }

        function closeTool(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function reloadFrame(id) { document.getElementById(id).src = document.getElementById(id).src; }

        // --- منطق المحرر ---
        let lastPage = null;
        let savedRange = null;

        function toggleFocusMode() {
            const top = document.getElementById('editor-top-section');
            const fab = document.getElementById('focus-fab');
            if (top.style.display === 'none') {
                top.style.display = 'block'; fab.style.display = 'none';
            } else {
                top.style.display = 'none'; fab.style.display = 'block';
            }
            setTimeout(scaleEditor, 100);
        }

        function scaleEditor() {
            if (window.innerWidth < 850) return; // لا تحجيم على الموبايل
            const wrapper = document.getElementById('editor-scroll');
            const scaler = document.getElementById('page-scaler');
            if(!wrapper || !scaler) return;
            const a4W = 794; 
            const screenW = wrapper.clientWidth;
            const scale = (screenW - 40) / a4W;
            if (scale < 1) {
                scaler.style.transform = `scale(${scale})`;
                scaler.style.marginBottom = `-${(1-scale)*100}%`;
            } else {
                scaler.style.transform = 'none';
                scaler.style.marginBottom = '0';
            }
        }

        function saveSel() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && sel.getRangeAt(0).commonAncestorContainer.parentElement.closest('.a4-page')) {
                savedRange = sel.getRangeAt(0);
            }
        }

        // مراقبة التحديد لحفظه
        document.addEventListener('selectionchange', saveSel);
        document.addEventListener('keyup', saveSel);
        document.addEventListener('mouseup', saveSel);

        function addNewPage() {
            const container = document.getElementById('page-scaler');
            const num = container.children.length + 1;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            
            const div = document.createElement('div');
            div.className = 'a4-page';
            div.contentEditable = true;
            div.id = 'page-'+num;
            div.setAttribute('placeholder', `الصفحة ${num}: ابدأ الكتابة...`);
            
            // زر الحذف المحدث (داخل الورقة)
            const del = document.createElement('div');
            del.className = 'delete-page-btn';
            del.contentEditable = false;
            del.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`;
            del.onclick = (e) => {
                e.stopPropagation();
                if (container.children.length <= 1) {
                    div.innerText = ''; 
                    showToast("تم مسح الصفحة");
                } else {
                    if(confirm('حذف الصفحة؟')) wrapper.remove();
                }
            };
            
            div.appendChild(del);
            wrapper.appendChild(div);
            container.appendChild(wrapper);
            
            div.addEventListener('focus', () => lastPage = div);
            div.addEventListener('mouseup', saveSel);
            div.addEventListener('keyup', saveSel);
            
            lastPage = div;
            div.focus();
        }

        function focusLastPage() {
            if(lastPage) lastPage.focus();
        }

        function formatDoc(cmd, val=null) {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
            document.execCommand(cmd, false, val);
            if(lastPage) lastPage.focus();
            saveSel();
        }

        function insertImage(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(lastPage) {
                        lastPage.focus();
                        // Restore selection
                        if (savedRange) {
                             const sel = window.getSelection();
                             sel.removeAllRanges();
                             sel.addRange(savedRange);
                        }
                        document.execCommand('insertImage', false, e.target.result);
                    } else { alert('اضغط داخل الصفحة أولاً'); }
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        
        function deselectImage() { /* Logic moved to simpler native resizing for stability */ }

        async function generatePDF() {
            const btn = event.currentTarget;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '...';
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pages = document.querySelectorAll('.a4-page');
            
            for(let i=0; i<pages.length; i++) {
                const p = pages[i];
                const delBtn = p.querySelector('.delete-page-btn');
                if(delBtn) delBtn.style.display = 'none';
                // Use html2canvas with white background
                const c = await html2canvas(p, {scale: 2, useCORS:true, backgroundColor: '#ffffff'});
                const img = c.toDataURL('image/jpeg', 0.95);
                if(i > 0) pdf.addPage();
                pdf.addImage(img, 'JPEG', 0, 0, 210, 297);
                if(delBtn) delBtn.style.display = 'flex';
            }
            pdf.save('document.pdf');
            btn.innerHTML = oldHtml;
        }

        // --- ToDo ---
        let todoList = [];
        function loadTodos() { const s = localStorage.getItem('todos_v2'); if(s) todoList = JSON.parse(s); renderTodos(); }
        function addTodo() { const inp = document.getElementById('todo-in'); const val = inp.value.trim(); if(!val) return; todoList.push({t:val, d:false, id:Date.now()}); saveTodos(); inp.value=''; }
        function saveTodos() { localStorage.setItem('todos_v2', JSON.stringify(todoList)); renderTodos(); }
        function renderTodos() { const c = document.getElementById('todo-list'); c.innerHTML = todoList.map(t => `<div class="todo-item bg-white/5 p-3 rounded-xl flex items-center gap-3 border border-white/10"><input type="checkbox" ${t.d?'checked':''} onchange="toggleTodo(${t.id})" class="w-5 h-5 accent-purple-500 rounded"><span class="flex-1 ${t.d?'line-through text-white/30':''}">${t.t}</span><button onclick="delTodo(${t.id})" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join(''); lucide.createIcons(); }
        window.toggleTodo = (id) => { const i = todoList.find(x=>x.id===id); i.d=!i.d; saveTodos(); };
        window.delTodo = (id) => { todoList = todoList.filter(x=>x.id!==id); saveTodos(); };

        // --- Chat ---
        async function sendMsg() {
            const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt) return;
            const box = document.getElementById('chat-box'); box.innerHTML += `<div class="flex gap-3 justify-end"><div class="bg-blue-600 p-3 rounded-xl rounded-tl-none text-sm">${txt}</div></div>`; inp.value='';
            setTimeout(() => { box.innerHTML += `<div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center"><i data-lucide="bot" class="w-4 h-4 text-white"></i></div><div class="bg-white/10 p-3 rounded-xl rounded-tr-none text-sm">تم الاستلام.</div></div>`; box.scrollTop = box.scrollHeight; lucide.createIcons(); }, 1000);
        }

        init();
    </script>
</body>
</html>

